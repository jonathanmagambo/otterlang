name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install LLVM 18
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-18 llvm-18-dev clang-18 || true
          # Try to install Polly if available (may not exist in all repos)
          sudo apt-get install -y libpolly-18-dev 2>/dev/null || echo "Polly not available in repo"
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-18" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/lib/llvm-18/lib:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
          # Set library search path for linker
          echo "LIBRARY_PATH=/usr/lib/llvm-18/lib:${LIBRARY_PATH:-}" >> $GITHUB_ENV
      
      - name: Install LLVM 18 (macOS)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          brew install llvm@18 || brew reinstall llvm@18
          echo "LLVM_SYS_181_PREFIX=$(brew --prefix llvm@18)" >> $GITHUB_ENV
          echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH
        env:
          HOMEBREW_NO_INSTALL_CLEANUP: 1
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Install LLVM 18.1 (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $llvmVersion = "18.1.8"
          $archive = "clang+llvm-$llvmVersion-x86_64-pc-windows-msvc.tar.xz"
          $downloadUrl = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$llvmVersion/$archive"
          $downloadPath = Join-Path $env:RUNNER_TEMP $archive

          Write-Host "Downloading LLVM $llvmVersion from $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath -UseBasicParsing

          Write-Host "Extracting archive"
          tar -C $env:RUNNER_TEMP -xf $downloadPath

          $llvmPath = Join-Path $env:RUNNER_TEMP "clang+llvm-$llvmVersion-x86_64-pc-windows-msvc"
          if (-not (Test-Path $llvmPath)) {
            throw "Failed to extract LLVM archive to $llvmPath"
          }

          $llvmBin = Join-Path $llvmPath "bin"
          $llvmConfig = Join-Path $llvmBin "llvm-config.exe"
          if (-not (Test-Path $llvmConfig)) {
            throw "llvm-config.exe was not found under $llvmPath. The llvm-sys crate requires it."
          }

          Write-Host "LLVM installed at: $llvmPath"
          "LLVM_SYS_181_PREFIX=$llvmPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LIBCLANG_PATH=$llvmBin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_HOME=$llvmPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_CONFIG_PATH=$llvmConfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$llvmBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "llvm-config version:"
          & $llvmConfig --version

          Write-Host "Clang version:"
          & (Join-Path $llvmBin "clang.exe") --version

      - name: Install libxml2 (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "Installing libxml2 via Chocolatey..."
          choco install libxml2 -y --no-progress

          $libRoot = "C:\ProgramData\chocolatey\lib\libxml2"
          if (-not (Test-Path $libRoot)) {
            throw "libxml2 root not found at $libRoot"
          }

          $libFile = Get-ChildItem -Path $libRoot -Recurse -Filter libxml2s.lib | Select-Object -First 1
          if (-not $libFile) {
            throw "Unable to locate libxml2s.lib after installation"
          }
          $libDir = $libFile.DirectoryName

          Write-Host "libxml2 library path: $libDir"
          "LIB=$libDir;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LIBXML2_LIB_PATH=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          $includeDir = Get-ChildItem -Path $libRoot -Recurse -Directory |
            Where-Object { Test-Path (Join-Path $_.FullName 'libxml\xmlversion.h') } |
            Select-Object -First 1
          if ($includeDir) {
            $incPath = $includeDir.FullName
            Write-Host "libxml2 include path: $incPath"
            "LIBXML2_INCLUDE_PATH=$incPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Warning "Could not determine libxml2 include directory"
          }
      
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Cache Cargo dependencies (Windows)
        uses: actions/cache@v4
        if: ${{ matrix.os == 'windows-latest' }}
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build
        run: cargo build --verbose
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Build (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: cargo build --verbose
      
      - name: Run tests
        run: cargo test --verbose
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Run tests (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: cargo test --verbose
      
      - name: Build examples
        run: |
          cargo build --release
          find examples -name "*.ot" -type f | while read -r example; do
            cargo run --release -- run "$example" || true
          done
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Build examples (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          cargo build --release
          $examples = Get-ChildItem -Path examples -Filter *.ot -Recurse
          if ($examples.Count -eq 0) {
            Write-Host "No .ot files found in examples directory"
            exit 0
          }
          foreach ($example in $examples) {
            Write-Host "Running example: $($example.FullName)"
            try {
              cargo run --release -- run $example.FullName
            } catch {
              Write-Host "Example $($example.Name) failed, continuing..."
            }
          }
